---

title: output


keywords: fastai
sidebar: home_sidebar



nb_path: "06_output.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 06_output.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">interlap</span> <span class="kn">import</span> <span class="n">InterLap</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="OutputAssembly" class="doc_header"><code>class</code> <code>OutputAssembly</code><a href="https://github.com/TF-Chan-Lab/LAFITE/tree/master/LAFITE/output.py#L16" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>OutputAssembly</code>(<strong><code>collected_refined_isoforms</code></strong>, <strong><code>output</code></strong>, <strong><code>label</code></strong>, <strong><code>relative_abundance_threshold</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">OutputAssembly</span><span class="p">:</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collected_refined_isoforms</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">relative_abundance_threshold</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">collected_refined_isoforms</span> <span class="o">=</span> <span class="n">collected_refined_isoforms</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">relative_abundance_threshold</span> <span class="o">=</span> <span class="n">relative_abundance_threshold</span>
		

	<span class="k">def</span> <span class="nf">idx_rearrange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">loci_ID</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">),</span> <span class="n">refined_isoforms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_refined_isoforms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">chrand2loci</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
			<span class="n">exon2loci_ID</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
			<span class="n">exon_interlap</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">full_block</span><span class="p">,</span> <span class="n">read_attribute</span> <span class="ow">in</span> <span class="n">refined_isoforms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">read_attribute</span><span class="o">.</span><span class="n">chrand_ID</span> <span class="ow">in</span> <span class="n">chrand2loci</span><span class="p">:</span>
						<span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span> <span class="o">=</span> <span class="n">chrand2loci</span><span class="p">[</span><span class="n">read_attribute</span><span class="o">.</span><span class="n">chrand_ID</span><span class="p">]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">loci_ID</span> <span class="o">+=</span> <span class="mi">1</span>
						<span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span> <span class="o">=</span> <span class="n">loci_ID</span>
						<span class="n">chrand2loci</span><span class="p">[</span><span class="n">read_attribute</span><span class="o">.</span><span class="n">chrand_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">loci_ID</span>
					<span class="n">full_block</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">full_block</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">exon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">full_block</span><span class="p">,</span> <span class="n">full_block</span><span class="p">):</span>
						<span class="n">exon2loci_ID</span><span class="p">[</span><span class="n">exon</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span>
						<span class="n">exon_interlap</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">exon</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">exon_interlap</span><span class="p">:</span>
						<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exon_interlap</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
							<span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">exon_interlap</span><span class="p">)</span>
							<span class="n">exon_interlap</span> <span class="o">=</span> <span class="n">InterLap</span><span class="p">()</span>
							<span class="n">exon_interlap</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

						<span class="n">overlap_ref</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">exon_interlap</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">full_block</span><span class="p">))</span>
						<span class="k">if</span> <span class="n">overlap_ref</span><span class="p">:</span>
							<span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span> <span class="o">=</span> <span class="n">exon2loci_ID</span><span class="p">[</span><span class="n">overlap_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span><span class="p">:</span>
						<span class="n">loci_ID</span> <span class="o">+=</span> <span class="mi">1</span>
						<span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span> <span class="o">=</span> <span class="n">loci_ID</span>

		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_refined_isoforms</span>
	
	<span class="k">def</span> <span class="nf">write_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">collected_refined_isoforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_rearrange</span><span class="p">()</span>
		<span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">),</span> <span class="n">refined_isoforms</span> <span class="ow">in</span> <span class="n">collected_refined_isoforms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([(</span><span class="n">k</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">refined_isoforms</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
				<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;full_block&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">refined_isoforms</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
				<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;loci_ID&#39;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">loci</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">loci</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
					<span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;abundance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;abundance&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_abundance_threshold</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;read_tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;Reference&quot;</span><span class="p">))]</span>
					<span class="n">tmp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

					<span class="n">isoform_idx</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
						<span class="n">full_block</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">polya_count</span><span class="p">,</span> <span class="n">fsm</span><span class="p">,</span> <span class="n">polyaed</span><span class="p">,</span> <span class="n">as_site</span><span class="p">,</span> <span class="n">apa_site</span><span class="p">,</span> <span class="n">collasped_name</span><span class="p">,</span> <span class="n">rss_dis</span><span class="p">,</span> <span class="n">read_tag</span><span class="p">,</span> <span class="n">processed</span><span class="p">,</span> <span class="n">chrand_ID</span><span class="p">,</span> <span class="n">abundance</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">as_site</span><span class="p">:</span>
							<span class="n">as_site</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">as_site</span><span class="p">])</span>
							<span class="n">apa_site</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">apa_site</span><span class="p">])</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">as_site</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
							<span class="n">apa_site</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
						<span class="n">isoform_idx</span> <span class="o">+=</span> <span class="mi">1</span>
						<span class="n">attribute</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;gene_id &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">loci</span><span class="si">}</span><span class="s1">&quot;; transcript_id &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">loci</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">isoform_idx</span><span class="si">}</span><span class="s1">&quot;; distance_to_nearset_TSS &quot;</span><span class="si">{</span><span class="n">rss_dis</span><span class="si">}</span><span class="s1">&quot;; full_length_count &quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">&quot;; full_length_PolyA_count &quot;</span><span class="si">{</span><span class="n">polya_count</span><span class="si">}</span><span class="s1">&quot;; alternative_TSS &quot;</span><span class="si">{</span><span class="n">as_site</span><span class="si">}</span><span class="s1">&quot;; alternative_TES &quot;</span><span class="si">{</span><span class="n">apa_site</span><span class="si">}</span><span class="s1">&quot;; isoform_class &quot;</span><span class="si">{</span><span class="n">read_tag</span><span class="si">}</span><span class="s1">&quot;;&#39;</span>
						<span class="n">isoform_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">chrom</span><span class="p">,</span> <span class="s1">&#39;LAFITE&#39;</span><span class="p">,</span> <span class="s1">&#39;transcript&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_block</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span>
						<span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">isoform_info</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

						<span class="n">exon_idx</span> <span class="o">=</span> <span class="mi">0</span>
						<span class="n">full_block</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">full_block</span><span class="p">)</span>
						<span class="k">for</span> <span class="n">exon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">full_block</span><span class="p">,</span> <span class="n">full_block</span><span class="p">):</span>
							<span class="n">exon_idx</span> <span class="o">+=</span> <span class="mi">1</span>
							<span class="n">attribute</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;gene_id &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">loci</span><span class="si">}</span><span class="s1">&quot;; transcript_id &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">loci</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">isoform_idx</span><span class="si">}</span><span class="s1">&quot;; exon_number &quot;</span><span class="si">{</span><span class="n">exon_idx</span><span class="si">}</span><span class="s1">&quot;;&#39;</span>
							<span class="n">exon_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">chrom</span><span class="p">,</span> <span class="s1">&#39;LAFITE&#39;</span><span class="p">,</span> <span class="s1">&#39;exon&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span>
							<span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exon_info</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="idx_rearrange" class="doc_header"><code>idx_rearrange</code><a href="https://github.com/TF-Chan-Lab/LAFITE/tree/master/LAFITE/output.py#L97" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>idx_rearrange</code>(<strong><code>collected_refined_isoforms</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">idx_rearrange</span><span class="p">(</span><span class="n">collected_refined_isoforms</span><span class="p">):</span>
	<span class="n">loci_ID</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">),</span> <span class="n">refined_isoforms</span> <span class="ow">in</span> <span class="n">collected_refined_isoforms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="n">chrand2loci</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
		<span class="n">exon2loci_ID</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
		<span class="n">exon_interlap</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">full_block</span><span class="p">,</span> <span class="n">read_attribute</span> <span class="ow">in</span> <span class="n">refined_isoforms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">read_attribute</span><span class="o">.</span><span class="n">chrand_ID</span> <span class="ow">in</span> <span class="n">chrand2loci</span><span class="p">:</span>
					<span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span> <span class="o">=</span> <span class="n">chrand2loci</span><span class="p">[</span><span class="n">read_attribute</span><span class="o">.</span><span class="n">chrand_ID</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">loci_ID</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span> <span class="o">=</span> <span class="n">loci_ID</span>
					<span class="n">chrand2loci</span><span class="p">[</span><span class="n">read_attribute</span><span class="o">.</span><span class="n">chrand_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">loci_ID</span>
				<span class="n">full_block</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">full_block</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">exon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">full_block</span><span class="p">,</span> <span class="n">full_block</span><span class="p">):</span>
					<span class="n">exon2loci_ID</span><span class="p">[</span><span class="n">exon</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span>
					<span class="n">exon_interlap</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">exon</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">exon_interlap</span><span class="p">:</span>
					<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exon_interlap</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
						<span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">exon_interlap</span><span class="p">)</span>
						<span class="n">exon_interlap</span> <span class="o">=</span> <span class="n">InterLap</span><span class="p">()</span>
						<span class="n">exon_interlap</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

					<span class="n">overlap_ref</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">exon_interlap</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">full_block</span><span class="p">))</span>
					<span class="k">if</span> <span class="n">overlap_ref</span><span class="p">:</span>
						<span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span> <span class="o">=</span> <span class="n">exon2loci_ID</span><span class="p">[</span><span class="n">overlap_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span><span class="p">:</span>
					<span class="n">loci_ID</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="n">read_attribute</span><span class="o">.</span><span class="n">loci_ID</span> <span class="o">=</span> <span class="n">loci_ID</span>
	<span class="k">return</span> <span class="n">collected_refined_isoforms</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="assembly_output" class="doc_header"><code>assembly_output</code><a href="https://github.com/TF-Chan-Lab/LAFITE/tree/master/LAFITE/output.py#L133" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>assembly_output</code>(<strong><code>collected_refined_isoforms</code></strong>, <strong><code>output</code></strong>, <strong><code>label</code></strong>, <strong><code>relative_abundance_threshold</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">assembly_output</span><span class="p">(</span><span class="n">collected_refined_isoforms</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">relative_abundance_threshold</span><span class="p">):</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">),</span> <span class="n">refined_isoforms</span> <span class="ow">in</span> <span class="n">collected_refined_isoforms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([(</span><span class="n">k</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">refined_isoforms</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;full_block&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
		<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;loci_ID&#39;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">loci</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">loci</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;abundance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;abundance&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">relative_abundance_threshold</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;read_tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;Reference&quot;</span><span class="p">))]</span>
			<span class="n">tmp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

			<span class="n">isoform_idx</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
				<span class="n">full_block</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">polya_count</span><span class="p">,</span> <span class="n">fsm</span><span class="p">,</span> <span class="n">polyaed</span><span class="p">,</span> <span class="n">as_site</span><span class="p">,</span> <span class="n">apa_site</span><span class="p">,</span> <span class="n">collasped_name</span><span class="p">,</span> <span class="n">rss_dis</span><span class="p">,</span> <span class="n">read_tag</span><span class="p">,</span> <span class="n">processed</span><span class="p">,</span> <span class="n">chrand_ID</span><span class="p">,</span> <span class="n">abundance</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">as_site</span><span class="p">:</span>
					<span class="n">as_site</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">as_site</span><span class="p">])</span>
					<span class="n">apa_site</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">apa_site</span><span class="p">])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">as_site</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
					<span class="n">apa_site</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
				<span class="n">isoform_idx</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="n">attribute</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;gene_id &quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">loci</span><span class="si">}</span><span class="s1">&quot;; transcript_id &quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">loci</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">isoform_idx</span><span class="si">}</span><span class="s1">&quot;; distance_to_nearset_TSS &quot;</span><span class="si">{</span><span class="n">rss_dis</span><span class="si">}</span><span class="s1">&quot;; full_length_count &quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">&quot;; full_length_PolyA_count &quot;</span><span class="si">{</span><span class="n">polya_count</span><span class="si">}</span><span class="s1">&quot;; alternative_TSS &quot;</span><span class="si">{</span><span class="n">as_site</span><span class="si">}</span><span class="s1">&quot;; alternative_TES &quot;</span><span class="si">{</span><span class="n">apa_site</span><span class="si">}</span><span class="s1">&quot;; isoform_class &quot;</span><span class="si">{</span><span class="n">read_tag</span><span class="si">}</span><span class="s1">&quot;;&#39;</span>
				<span class="n">isoform_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">chrom</span><span class="p">,</span> <span class="s1">&#39;LAFITE&#39;</span><span class="p">,</span> <span class="s1">&#39;transcript&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">isoform_info</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

				<span class="n">exon_idx</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="n">full_block</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">full_block</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">exon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">full_block</span><span class="p">,</span> <span class="n">full_block</span><span class="p">):</span>
					<span class="n">exon_idx</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="n">attribute</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;gene_id &quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">loci</span><span class="si">}</span><span class="s1">&quot;; transcript_id &quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">loci</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">isoform_idx</span><span class="si">}</span><span class="s1">&quot;; exon_number &quot;</span><span class="si">{</span><span class="n">exon_idx</span><span class="si">}</span><span class="s1">&quot;;&#39;</span>
					<span class="n">exon_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">chrom</span><span class="p">,</span> <span class="s1">&#39;LAFITE&#39;</span><span class="p">,</span> <span class="s1">&#39;exon&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span>
					<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exon_info</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

