---

title: reference_processing


keywords: fastai
sidebar: home_sidebar



nb_path: "01_reference_processing.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_reference_processing.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">interlap</span> <span class="kn">import</span> <span class="n">InterLap</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">LAFITE.utils</span> <span class="kn">import</span> <span class="n">Vividict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gtf_line_split" class="doc_header"><code>gtf_line_split</code><a href="https://github.com/TF-Chan-Lab/LAFITE/tree/master/LAFITE/reference_processing.py#L16" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gtf_line_split</code>(<strong><code>entry</code></strong>)</p>
</blockquote>
<p>split gtf line</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">gtf_line_split</span> <span class="p">(</span><span class="n">entry</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;split gtf line</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">lst</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
	<span class="n">chrom</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">attribute</span> <span class="o">=</span> <span class="n">lst</span>
	<span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
	<span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">attribute</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">gtf2splicing</span><span class="p">(</span><span class="n">gtf</span><span class="p">,</span> <span class="n">transcript_ref</span> <span class="o">=</span> <span class="s1">&#39;transcript_id&#39;</span><span class="p">,</span> <span class="n">gene_ref</span> <span class="o">=</span> <span class="s1">&#39;gene_id&#39;</span><span class="p">,</span> <span class="n">keepAttribute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mergeMode</span> <span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;preprocess the gtf file to gene and isoform level</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">isoform_structure_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
	<span class="n">gene_structure_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
	<span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">gtf</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
				<span class="n">chrom</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">gtf_line_split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
				
				<span class="k">try</span><span class="p">:</span>
					<span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">mergeMode</span><span class="p">:</span>
						<span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">gene_ref</span><span class="p">,</span> <span class="n">transcript_ref</span><span class="p">])]</span>
					<span class="n">attributes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">])</span>

				<span class="k">except</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fatal: please check input GTF format!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

				<span class="k">if</span> <span class="n">keepAttribute</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;transcript&#39;</span><span class="p">,</span> <span class="s1">&#39;mRNA&#39;</span><span class="p">):</span>
						<span class="n">gene_id</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">gene_ref</span><span class="p">]</span>
						<span class="n">transcript_id</span>  <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">transcript_ref</span><span class="p">]</span>
						<span class="n">isoform_structure_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">transcript_id</span><span class="p">,</span> <span class="n">gene_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">attributes</span><span class="p">]</span>

				<span class="k">if</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;exon&quot;</span><span class="p">:</span>
					<span class="n">gene_id</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">gene_ref</span><span class="p">]</span>
					<span class="n">transcript_id</span>  <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">transcript_ref</span><span class="p">]</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">gene_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gene_structure_dict</span><span class="p">:</span>
						<span class="n">gene_structure_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">gene_id</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">gene_structure_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">gene_id</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">])</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">transcript_id</span><span class="p">,</span> <span class="n">gene_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">isoform_structure_dict</span><span class="p">:</span>
						<span class="n">isoform_structure_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">transcript_id</span><span class="p">,</span> <span class="n">gene_id</span><span class="p">)]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">isoform_structure_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">transcript_id</span><span class="p">,</span> <span class="n">gene_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">]</span>

	<span class="k">return</span> <span class="n">gene_structure_dict</span><span class="p">,</span> <span class="n">isoform_structure_dict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gtf2splicing" class="doc_header"><code>gtf2splicing</code><a href="https://github.com/TF-Chan-Lab/LAFITE/tree/master/LAFITE/reference_processing.py#L28" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gtf2splicing</code>(<strong><code>gtf</code></strong>, <strong><code>transcript_ref</code></strong>=<em><code>'transcript_id'</code></em>, <strong><code>keepAttribute</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>preprocess the gtf file to gene and isoform level</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">gtf2splicing</span><span class="p">(</span><span class="n">gtf</span><span class="p">,</span> <span class="n">transcript_ref</span> <span class="o">=</span> <span class="s1">&#39;transcript_id&#39;</span><span class="p">,</span> <span class="n">keepAttribute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;preprocess the gtf file to gene and isoform level</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">isoform_structure_dict</span> <span class="o">=</span> <span class="n">Vividict</span><span class="p">()</span>
	<span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">gtf</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
				<span class="n">chrom</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">gtf_line_split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
				
				<span class="k">try</span><span class="p">:</span>
					<span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">attributes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">])</span>

				<span class="k">except</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fatal: please check input GTF format</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

				<span class="k">if</span> <span class="n">keepAttribute</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;transcript&#39;</span><span class="p">,</span> <span class="s1">&#39;mRNA&#39;</span><span class="p">):</span>
						<span class="n">transcript_id</span>  <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">transcript_ref</span><span class="p">]</span>
						<span class="n">isoform_structure_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)][</span><span class="n">transcript_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">attributes</span><span class="p">]</span>

				<span class="k">if</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;exon&quot;</span><span class="p">:</span>
					<span class="n">transcript_id</span>  <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">transcript_ref</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">transcript_id</span> <span class="ow">in</span> <span class="n">isoform_structure_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]:</span>
						<span class="n">isoform_structure_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)][</span><span class="n">transcript_id</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">isoform_structure_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)][</span><span class="n">transcript_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">]</span>

	<span class="k">return</span> <span class="n">isoform_structure_dict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RefAnnotationExtraction</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	extraction the splicing/exon information from the reference annotation</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_gtf</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ref_gtf</span> <span class="o">=</span> <span class="n">ref_gtf</span>

	<span class="k">def</span> <span class="nf">annotation_extraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

		<span class="n">ref_exon</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span> <span class="c1"># reference exon start and end sites, the key will be chromosome, strand</span>
		<span class="n">ref_junction</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span> <span class="c1"># splicing junction from reference annotation</span>
		<span class="n">ref_mutple_exon_trans</span> <span class="o">=</span> <span class="n">Vividict</span><span class="p">()</span> <span class="c1"># splicing list for every chromosome, e.g. {&#39;chr1,+&#39;:[[1,2,3,4,5],[111,223,44]], &#39;chr1,-&#39;:[[xxx,xxx,xxx],[xxx,xx,xxxx]]}</span>
		<span class="n">ref_single_exon_trans</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span> <span class="c1"># splicing list for every chromosome, but only for single exon transcript</span>
		<span class="n">left_sj_set</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
		<span class="n">right_sj_set</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
		<span class="n">tss_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span> <span class="c1">#  transcript start sites set</span>

		<span class="n">gene_structure_dict</span><span class="p">,</span> <span class="n">ref_trans_structure_dict</span> <span class="o">=</span> <span class="n">gtf2splicing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_gtf</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">isoform</span><span class="p">,</span> <span class="n">splicing_lst</span> <span class="ow">in</span> <span class="n">ref_trans_structure_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">transcript_id</span><span class="p">,</span> <span class="n">gene_id</span> <span class="o">=</span> <span class="n">isoform</span>
			<span class="n">splicing_lst</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
			<span class="n">read_splicing</span> <span class="o">=</span> <span class="n">splicing_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">splicing_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">splicing_lst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

			<span class="c1"># record the TSS</span>
			<span class="n">tss_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="n">tss_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

			<span class="k">if</span> <span class="ow">not</span> <span class="n">read_splicing</span><span class="p">:</span>
				<span class="c1"># record single exon trans start and end site</span>
				<span class="n">ref_single_exon_trans</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c1"># record the splicing site, splicing junction, exon for multi exon trans</span>
				<span class="n">splicing_lst</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">splicing_lst</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exon</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">splicing_lst</span><span class="p">,</span><span class="n">splicing_lst</span><span class="p">)):</span>
					<span class="n">ref_exon</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">exon</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="n">right_sj</span> <span class="o">=</span> <span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
						<span class="n">left_sj_set</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">left_sj</span><span class="p">)</span>
						<span class="n">right_sj_set</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">right_sj</span><span class="p">)</span>
						<span class="n">ref_junction</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">left_sj</span><span class="p">,</span><span class="n">right_sj</span><span class="p">))</span>
					<span class="n">left_sj</span> <span class="o">=</span> <span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

				<span class="c1"># record the splicing structure and the tss and tes for multi exon trans</span>
				<span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
				<span class="c1"># 	read_splicing.reverse()</span>
					<span class="n">se_site</span> <span class="o">=</span> <span class="p">[</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">se_site</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span>

				<span class="n">ref_mutple_exon_trans</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)][</span><span class="nb">tuple</span><span class="p">(</span><span class="n">read_splicing</span><span class="p">)]</span> <span class="o">=</span> <span class="n">se_site</span>

		<span class="k">return</span> <span class="n">ref_exon</span><span class="p">,</span> <span class="n">ref_junction</span><span class="p">,</span> <span class="n">ref_single_exon_trans</span><span class="p">,</span> <span class="n">ref_mutple_exon_trans</span><span class="p">,</span> <span class="n">left_sj_set</span><span class="p">,</span> <span class="n">right_sj_set</span><span class="p">,</span> <span class="n">tss_dict</span>

	<span class="k">def</span> <span class="nf">annotation_sorting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

		<span class="n">ref_exon</span><span class="p">,</span> <span class="n">ref_junction</span><span class="p">,</span> <span class="n">ref_single_exon_trans</span><span class="p">,</span> <span class="n">ref_mutple_exon_trans</span><span class="p">,</span> <span class="n">left_sj_set</span><span class="p">,</span> <span class="n">right_sj_set</span><span class="p">,</span> <span class="n">tss_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_extraction</span><span class="p">()</span>

		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tss_dict</span><span class="p">:</span>
			<span class="n">tss_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tss_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ref_mutple_exon_trans</span><span class="p">:</span>
			<span class="c1"># sort multi exon transcript by splicing junction number</span>
			<span class="n">tmp_dict</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ref_mutple_exon_trans</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
				<span class="n">tmp_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_mutple_exon_trans</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
			<span class="n">ref_mutple_exon_trans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_dict</span>

		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">left_sj_set</span><span class="p">:</span>
			<span class="n">left_sj_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">left_sj_set</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">right_sj_set</span><span class="p">:</span>
			<span class="n">right_sj_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">right_sj_set</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

		<span class="c1"># covert to interlap data format</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ref_single_exon_trans</span><span class="p">:</span>
			<span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ref_single_exon_trans</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">ref_single_exon_trans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">InterLap</span><span class="p">()</span>
			<span class="n">ref_single_exon_trans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ref_exon</span><span class="p">:</span>
			<span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ref_exon</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">ref_exon</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">InterLap</span><span class="p">()</span>
			<span class="n">ref_exon</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">ref_exon</span><span class="p">,</span> <span class="n">ref_junction</span><span class="p">,</span> <span class="n">ref_single_exon_trans</span><span class="p">,</span> <span class="n">ref_mutple_exon_trans</span><span class="p">,</span> <span class="n">left_sj_set</span><span class="p">,</span> <span class="n">right_sj_set</span><span class="p">,</span> <span class="n">tss_dict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RefAnnotationExtraction" class="doc_header"><code>class</code> <code>RefAnnotationExtraction</code><a href="https://github.com/TF-Chan-Lab/LAFITE/tree/master/LAFITE/reference_processing.py#L60" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RefAnnotationExtraction</code>(<strong><code>chrom</code></strong>, <strong><code>strand</code></strong>, <strong><code>chrand_ref_trans_structure_dict</code></strong>)</p>
</blockquote>
<p>extraction the splicing/exon information from the reference annotation</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RefAnnotationExtraction</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	extraction the splicing/exon information from the reference annotation</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">chrand_ref_trans_structure_dict</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">chrom</span> <span class="o">=</span> <span class="n">chrom</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">=</span> <span class="n">strand</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">chrand_ref_trans_structure_dict</span> <span class="o">=</span> <span class="n">chrand_ref_trans_structure_dict</span>

	<span class="k">def</span> <span class="nf">annotation_extraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

		<span class="n">chrand_ref_exon</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># reference exon start and end sites, the key will be chromosome, strand</span>
		<span class="n">chrand_ref_junction</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># splicing junction from reference annotation</span>
		<span class="n">chrand_ref_mutple_exon_trans</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span> <span class="c1"># splicing list for every chromosome, e.g. {&#39;chr1,+&#39;:[[1,2,3,4,5],[111,223,44]], &#39;chr1,-&#39;:[[xxx,xxx,xxx],[xxx,xx,xxxx]]}</span>
		<span class="n">chrand_ref_single_exon_trans</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># splicing list for every chromosome, but only for single exon transcript</span>
		<span class="n">chrand_left_sj_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="n">chrand_right_sj_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="n">chrand_tss_dict</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1">#  transcript start sites set</span>

		<span class="k">for</span> <span class="n">isoform</span><span class="p">,</span> <span class="n">full_block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chrand_ref_trans_structure_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">full_block</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
			<span class="n">iso_splicing</span> <span class="o">=</span> <span class="n">full_block</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">full_block</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">full_block</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

			<span class="c1"># record the TSS</span>
			<span class="n">chrand_tss_dict</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="n">chrand_tss_dict</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

			<span class="k">if</span> <span class="ow">not</span> <span class="n">iso_splicing</span><span class="p">:</span>
				<span class="c1"># record single exon trans start and end site</span>
				<span class="n">chrand_ref_single_exon_trans</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c1"># record the splicing site, splicing junction, exon for multi exon trans</span>
				<span class="n">full_block</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">full_block</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exon</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">full_block</span><span class="p">,</span><span class="n">full_block</span><span class="p">)):</span>
					<span class="n">chrand_ref_exon</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">exon</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="n">right_sj</span> <span class="o">=</span> <span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
						<span class="n">chrand_left_sj_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">left_sj</span><span class="p">)</span>
						<span class="n">chrand_right_sj_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">right_sj</span><span class="p">)</span>
						<span class="n">chrand_ref_junction</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">left_sj</span><span class="p">,</span><span class="n">right_sj</span><span class="p">))</span>
					<span class="n">left_sj</span> <span class="o">=</span> <span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

				<span class="c1"># record the splicing structure and the tss and tes for multi exon trans</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
					<span class="n">se_site</span> <span class="o">=</span> <span class="p">[</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">se_site</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span>
				<span class="n">chrand_ref_mutple_exon_trans</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">iso_splicing</span><span class="p">)]</span> <span class="o">=</span> <span class="n">se_site</span>

		<span class="k">return</span> <span class="n">chrand_ref_exon</span><span class="p">,</span> <span class="n">chrand_ref_junction</span><span class="p">,</span> <span class="n">chrand_ref_single_exon_trans</span><span class="p">,</span> <span class="n">chrand_ref_mutple_exon_trans</span><span class="p">,</span> <span class="n">chrand_left_sj_set</span><span class="p">,</span> <span class="n">chrand_right_sj_set</span><span class="p">,</span> <span class="n">chrand_tss_dict</span>

	<span class="k">def</span> <span class="nf">annotation_sorting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

		<span class="n">chrand_ref_exon</span><span class="p">,</span> <span class="n">chrand_ref_junction</span><span class="p">,</span> <span class="n">chrand_ref_single_exon_trans</span><span class="p">,</span> <span class="n">chrand_ref_mutple_exon_trans</span><span class="p">,</span> <span class="n">chrand_left_sj_set</span><span class="p">,</span> <span class="n">chrand_right_sj_set</span><span class="p">,</span> <span class="n">chrand_tss_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_extraction</span><span class="p">()</span>

		<span class="n">chrand_tss_dict</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chrand_tss_dict</span><span class="p">)</span>
		<span class="c1"># sort multi exon transcript by splicing junction number</span>
		<span class="n">chrand_ref_mutple_exon_trans</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">chrand_ref_mutple_exon_trans</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

		<span class="n">chrand_left_sj_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chrand_left_sj_set</span><span class="p">)</span>
		<span class="n">chrand_right_sj_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chrand_right_sj_set</span><span class="p">)</span>

		<span class="c1"># covert to interlap data format</span>
		<span class="k">if</span> <span class="n">chrand_ref_single_exon_trans</span><span class="p">:</span>
			<span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chrand_ref_single_exon_trans</span><span class="p">)</span>
			<span class="n">chrand_ref_single_exon_trans</span> <span class="o">=</span> <span class="n">InterLap</span><span class="p">()</span>
			<span class="n">chrand_ref_single_exon_trans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">chrand_ref_exon</span><span class="p">:</span>
			<span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chrand_ref_exon</span><span class="p">)</span>
			<span class="n">chrand_ref_exon</span> <span class="o">=</span> <span class="n">InterLap</span><span class="p">()</span>
			<span class="n">chrand_ref_exon</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chrom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> <span class="n">chrand_ref_exon</span><span class="p">,</span> <span class="n">chrand_ref_junction</span><span class="p">,</span> <span class="n">chrand_ref_single_exon_trans</span><span class="p">,</span> <span class="n">chrand_ref_mutple_exon_trans</span><span class="p">,</span> <span class="n">chrand_left_sj_set</span><span class="p">,</span> <span class="n">chrand_right_sj_set</span><span class="p">,</span> <span class="n">chrand_tss_dict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RefProcessWrapper" class="doc_header"><code>class</code> <code>RefProcessWrapper</code><a href="https://github.com/TF-Chan-Lab/LAFITE/tree/master/LAFITE/reference_processing.py#L139" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RefProcessWrapper</code>(<strong><code>ref_gtf</code></strong>, <strong><code>thread</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RefProcessWrapper</span><span class="p">:</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_gtf</span><span class="p">,</span> <span class="n">thread</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ref_gtf</span> <span class="o">=</span> <span class="n">ref_gtf</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">thread</span>
	
	<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">preprocess_lst</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ref_trans_structure_dict</span> <span class="o">=</span> <span class="n">gtf2splicing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_gtf</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">),</span> <span class="n">chrand_ref_trans_structure_dict</span> <span class="ow">in</span> <span class="n">ref_trans_structure_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">preprocess_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RefAnnotationExtraction</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">chrand_ref_trans_structure_dict</span><span class="p">))</span>
		<span class="k">with</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">)</span> <span class="k">as</span> <span class="n">parallel</span><span class="p">:</span>
			<span class="n">results</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">delayed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">annotation_sorting</span><span class="p">())(</span><span class="n">job</span><span class="p">)</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">preprocess_lst</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">results</span>
	
	<span class="k">def</span> <span class="nf">result_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
		<span class="n">ref_exon</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span> <span class="c1"># reference exon start and end sites, the key will be chromosome, strand</span>
		<span class="n">ref_junction</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span> <span class="c1"># splicing junction from reference annotation</span>
		<span class="n">ref_mutple_exon_trans</span> <span class="o">=</span> <span class="n">Vividict</span><span class="p">()</span> <span class="c1"># splicing list for every chromosome, e.g. {&#39;chr1,+&#39;:[[1,2,3,4,5],[111,223,44]], &#39;chr1,-&#39;:[[xxx,xxx,xxx],[xxx,xx,xxxx]]}</span>
		<span class="n">ref_single_exon_trans</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span> <span class="c1"># splicing list for every chromosome, but only for single exon transcript</span>
		<span class="n">left_sj_set</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
		<span class="n">right_sj_set</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
		<span class="n">tss_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span> <span class="c1">#  transcript start sites set</span>

		<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
			<span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">chrand_ref_exon</span><span class="p">,</span> <span class="n">chrand_ref_junction</span><span class="p">,</span> <span class="n">chrand_ref_single_exon_trans</span><span class="p">,</span> <span class="n">chrand_ref_mutple_exon_trans</span><span class="p">,</span> <span class="n">chrand_left_sj_set</span><span class="p">,</span> <span class="n">chrand_right_sj_set</span><span class="p">,</span> <span class="n">chrand_tss_dict</span> <span class="o">=</span> <span class="n">result</span>
			
			<span class="n">tss_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">)]</span> <span class="o">=</span> <span class="n">chrand_tss_dict</span>
			<span class="k">if</span> <span class="n">chrand_ref_exon</span><span class="p">:</span>
				<span class="n">ref_exon</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">)]</span> <span class="o">=</span> <span class="n">chrand_ref_exon</span>
			<span class="k">if</span> <span class="n">chrand_ref_junction</span><span class="p">:</span>
				<span class="n">ref_junction</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">)]</span> <span class="o">=</span> <span class="n">chrand_ref_junction</span>
			<span class="k">if</span> <span class="n">chrand_ref_mutple_exon_trans</span><span class="p">:</span>
				<span class="n">ref_mutple_exon_trans</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">)]</span> <span class="o">=</span> <span class="n">chrand_ref_mutple_exon_trans</span>
			<span class="k">if</span> <span class="n">chrand_ref_single_exon_trans</span><span class="p">:</span>
				<span class="n">ref_single_exon_trans</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">)]</span> <span class="o">=</span> <span class="n">chrand_ref_single_exon_trans</span>
			<span class="k">if</span> <span class="n">chrand_left_sj_set</span><span class="p">:</span>
				<span class="n">left_sj_set</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">)]</span> <span class="o">=</span> <span class="n">chrand_left_sj_set</span>
			<span class="k">if</span> <span class="n">chrand_right_sj_set</span><span class="p">:</span>
				<span class="n">right_sj_set</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">)]</span> <span class="o">=</span> <span class="n">chrand_right_sj_set</span>

		<span class="k">return</span> <span class="n">ref_exon</span><span class="p">,</span> <span class="n">ref_junction</span><span class="p">,</span> <span class="n">ref_single_exon_trans</span><span class="p">,</span> <span class="n">ref_mutple_exon_trans</span><span class="p">,</span> <span class="n">left_sj_set</span><span class="p">,</span> <span class="n">right_sj_set</span><span class="p">,</span> <span class="n">tss_dict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="short_reads_sj_import" class="doc_header"><code>short_reads_sj_import</code><a href="https://github.com/TF-Chan-Lab/LAFITE/tree/master/LAFITE/reference_processing.py#L186" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>short_reads_sj_import</code>(<strong><code>sj_tab</code></strong>, <strong><code>left_sj_set</code></strong>, <strong><code>right_sj_set</code></strong>)</p>
</blockquote>
<p>import the splicing junctions detected from short reads data (STAR SJ_tab)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">short_reads_sj_import</span><span class="p">(</span><span class="n">sj_tab</span><span class="p">,</span> <span class="n">left_sj_set</span><span class="p">,</span> <span class="n">right_sj_set</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;import the splicing junctions detected from short reads data (STAR SJ_tab)</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sj_tab</span><span class="p">:</span>
		<span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
				<span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">chrom</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">]:</span>
					<span class="n">strand</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">strand</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
				<span class="n">left_sj</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
				<span class="n">right_sj</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
				<span class="n">left_sj_set</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">left_sj</span><span class="p">)</span>
				<span class="n">right_sj_set</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">right_sj</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">left_sj_set</span><span class="p">:</span>
		<span class="n">left_sj_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">left_sj_set</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">right_sj_set</span><span class="p">:</span>
		<span class="n">right_sj_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">right_sj_set</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
	
	<span class="k">return</span> <span class="n">left_sj_set</span><span class="p">,</span> <span class="n">right_sj_set</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cage_tss_import" class="doc_header"><code>cage_tss_import</code><a href="https://github.com/TF-Chan-Lab/LAFITE/tree/master/LAFITE/reference_processing.py#L213" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cage_tss_import</code>(<strong><code>cage_tss</code></strong>, <strong><code>tss_dict</code></strong>)</p>
</blockquote>
<p>import the splicing junctions detected from short reads data (STAR SJ_tab)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">cage_tss_import</span><span class="p">(</span><span class="n">cage_tss</span><span class="p">,</span> <span class="n">tss_dict</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;import the splicing junctions detected from short reads data (STAR SJ_tab)</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">cage_tss</span><span class="p">:</span>
		<span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
				<span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
				<span class="n">tss_center</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">tss_center</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tss_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]:</span>
					<span class="n">tss_dict</span><span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tss_center</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tss_dict</span><span class="p">:</span>
		<span class="n">tss_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tss_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

	<span class="k">return</span> <span class="n">tss_dict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

